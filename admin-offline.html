<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Offline • Gerar produto com imagens embutidas</title>
<style>
  :root{--bg:#0f1220;--card:#11162a;--line:#1f2643;--text:#f7f8ff;--muted:#9aa3c1;--ring:rgba(110,231,183,.35);--ok:#22c55e}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0f1220,#0a0e1c);color:var(--text);font:500 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:880px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input, textarea, select{
    width:100%;background:#0d1226;color:var(--text);
    border:1px solid var(--line);border-radius:12px;padding:12px 14px;
    outline:none;box-shadow:0 0 0 0 var(--ring)
  }
  input:focus, textarea:focus, select:focus{box-shadow:0 0 0 6px var(--ring);border-color:transparent}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .drop{border:2px dashed #2a315f;border-radius:14px;padding:18px;text-align:center;cursor:pointer}
  .grid{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .thumb{position:relative;width:120px;height:120px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#0b0f24}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb button{position:absolute;top:6px;right:6px;background:#0009;color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .ok{color:var(--ok);font-weight:700}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid #2a315f;background:#162044;color:var(--text);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.primary{background:linear-gradient(90deg,#6ee7b7,#34d399);color:#04170f;border:0;font-weight:800}
  textarea#codigo{width:100%;min-height:140px;margin-top:12px;font-family:ui-monospace,Consolas,monospace}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .topbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 style="margin:0">Admin Offline — produto com imagens embutidas (Base64)</h1>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <!-- Botões úteis no topo -->
      <a class="btn" href="index.html" title="Voltar para a loja">← Voltar à Loja</a>
      <a class="btn primary" href="admin-gerenciar.html" title="Abrir tela de gestão">Ir para Gerenciar</a>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label for="titulo">Título</label>
        <input id="titulo" placeholder="Ex.: Placa-mãe ASUS B550">
      </div>
      <div>
        <label for="preco">Preço (R$)</label>
        <input id="preco" type="number" step="0.01" min="0" placeholder="799.90">
      </div>
    </div>

    <!-- NOVO: categoria -->
    <label for="categoria">Categoria</label>
    <select id="categoria">
      <option value="" selected disabled>Selecione a categoria</option>
      <option>Placa-mãe</option>
      <option>Processador (CPU)</option>
      <option>Memória RAM</option>
      <option>Placa de vídeo (GPU)</option>
      <option>HD (Disco Rígido)</option>
      <option>SSD</option>
      <option>Fonte</option>
      <option>Gabinete</option>
      <option>Cooler / Water Cooler</option>
      <option>Placa de som</option>
      <option>Placa de rede</option>
      <option>Drive de DVD (hoje pouco usado)</option>
      <option>Monitor</option>
      <option>Teclado</option>
      <option>Mouse</option>
      <option>Headset / Fone de ouvido</option>
      <option>Impressora</option>
      <option>Webcam</option>
    </select>

    <!-- descrição -->
    <label for="descricao">Descrição</label>
    <textarea id="descricao" placeholder="Detalhes do item, compatibilidade, garantia, observações etc."></textarea>

    <label>Fotos (arraste e solte ou clique)</label>
    <div id="dropzone" class="drop">
      <strong>Solte as imagens aqui</strong><br>
      <span class="muted">ou clique para selecionar arquivo(s)</span>
    </div>
    <input id="fileInput" type="file" accept="image/*" multiple hidden>
    <div class="muted">Compacto & embuto em Base64. Limite recomendado: ~900 KB totais por produto.</div>
    <div id="listaFotos" class="grid"></div>

    <div class="actions" style="margin-top:16px">
      <button class="btn" id="limpar">Limpar</button>
      <button class="btn primary" id="gerar">Gerar código .js</button>
    </div>

    <div id="msg" class="muted" style="margin-top:8px">Pronto para gerar.</div>
    <textarea id="codigo" readonly placeholder="// o código aparecerá aqui para você copiar"></textarea>

    <div class="actions" style="margin-top:8px">
      <button class="btn" id="baixar" disabled>Baixar produtos.js</button>
      <!-- Botão solicitado que leva para admin-gerenciar.html -->
      <a href="admin-gerenciar.html" class="btn primary" id="irGerenciar">Ir para Gerenciar</a>
    </div>
  </div>
</div>

<script>
  const fotos = []; // data URLs
  const drop = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const lista = document.getElementById('listaFotos');
  const msg   = document.getElementById('msg');
  const out   = document.getElementById('codigo');
  const btnGerar = document.getElementById('gerar');
  const btnBaixar = document.getElementById('baixar');
  const btnLimpar = document.getElementById('limpar');

  drop.addEventListener('click', ()=>fileInput.click());
  drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.borderColor='#6ee7b7';});
  drop.addEventListener('dragleave', ()=>drop.style.borderColor='#2a315f');
  drop.addEventListener('drop', async e=>{
    e.preventDefault(); drop.style.borderColor='#2a315f';
    await handleFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', async e=>{
    await handleFiles(e.target.files);
    fileInput.value='';
  });

  async function handleFiles(fl){
    for(const f of [...fl]){
      if(!f.type.startsWith('image/')) continue;
      const data = await toDataURLCompressed(f, 1280, 0.72);
      fotos.push(data);
    }
    render();
    checkSize();
  }

  function render(){
    lista.innerHTML = '';
    fotos.forEach((src,i)=>{
      const d = document.createElement('div');
      d.className='thumb';
      d.innerHTML = `<img src="${src}"><button data-i="${i}">✕</button>`;
      d.querySelector('button').onclick = ev => { fotos.splice(+ev.target.dataset.i,1); render(); checkSize(); };
      lista.appendChild(d);
    });
  }

  function approxBytes(){
    // dataURL ~= 4/3 do tamanho binário
    return fotos.reduce((a,f)=>a+Math.ceil(f.length*3/4),0);
  }
  function checkSize(){
    const bytes = approxBytes();
    const kb = Math.round(bytes/1024);
    msg.innerHTML = kb>900
      ? `⚠️ Você tem ~${kb} KB. Tente remover/comprimir para ficar < 900 KB.`
      : `✅ Total aproximado: ${kb} KB.`;
  }

  function toDataURLCompressed(file, maxW=1280, quality=0.72){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW/img.width);
          const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
          const c = document.createElement('canvas'); c.width=w; c.height=h;
          const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          const mime = file.type==='image/png' ? 'image/png' : 'image/jpeg';
          const q = mime==='image/jpeg' ? quality : undefined;
          resolve(c.toDataURL(mime, q));
        };
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  btnGerar.onclick = ()=>{
    const titulo = document.getElementById('titulo').value.trim() || 'Sem título';
    const preco  = Number(document.getElementById('preco').value||0);
    const descricao = document.getElementById('descricao').value.trim() || null;
    const categoria = document.getElementById('categoria').value || null;
    if(!fotos.length){ out.value='// adicione ao menos 1 foto'; return; }

    const produto = {
      titulo,
      preco,
      categoria,       // incluído
      descricao,       // incluído
      fotos: fotos,    // data URLs
      criadoEm: new Date().toISOString()
    };

    const codigo =
`// Arquivo gerado pelo admin-offline
window.PRODUTOS = window.PRODUTOS || [];
window.PRODUTOS.push(${JSON.stringify(produto,null,2)});`;

    out.value = codigo;
    btnBaixar.disabled = false;
  };

  btnBaixar.onclick = ()=>{
    const blob = new Blob([out.value], {type:'text/javascript;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'produtos.js';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  btnLimpar.onclick = ()=>{
    fotos.splice(0); render(); checkSize();
    out.value=''; btnBaixar.disabled=true;
    document.getElementById('titulo').value='';
    document.getElementById('preco').value='';
    document.getElementById('descricao').value='';
    document.getElementById('categoria').selectedIndex = 0;
  };
</script>
</body>
</html>
