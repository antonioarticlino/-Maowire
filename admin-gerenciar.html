<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin • Gerenciar Produtos</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{
    --bg:#0f1220; --bg2:#0a0e1c; --card:#11162a; --line:#1f2643;
    --text:#f7f8ff; --muted:#9aa3c1; --price:#6ee7b7; --btn:#34d399;
    --badge:#f59e0b; --ring:rgba(110,231,183,.35); --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);
       font:500 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:22px;margin:0}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    display:inline-flex;align-items:center;gap:8px;justify-content:center;
    padding:10px 14px;border-radius:12px;border:1px solid #2a315f;background:#162044;
    color:var(--text);cursor:pointer;text-decoration:none;font-weight:800
  }
  .btn.primary{background:linear-gradient(90deg,#6ee7b7,#34d399);color:#04170f;border:0}
  .btn.danger{background:linear-gradient(90deg,#fca5a5,#ef4444);color:#2b0c0c;border:0}
  .btn.ghost{background:transparent;border-color:#2a315f}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .bar{display:flex;gap:10px;align-items:center;margin:14px 0 10px;flex-wrap:wrap}
  .search{position:relative;flex:1 1 300px}
  .search input{
    width:100%; background:#0d1226; color:var(--text); border:1px solid var(--line);
    border-radius:999px; padding:12px 44px 12px 40px; outline:none; transition:.2s;
    box-shadow:0 0 0 0 var(--ring);
  }
  .search input:focus{box-shadow:0 0 0 6px var(--ring); border-color:transparent}
  .search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.8}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .item{background:#0b0f24;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .item-head{display:flex;gap:12px;padding:12px}
  .thumb{width:110px;height:110px;border-radius:10px;overflow:hidden;background:#0d1226;flex:0 0 auto;border:1px solid #223}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .meta{flex:1 1 auto;min-width:0}
  .meta h3{margin:0 0 4px;font-size:16px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .muted{color:var(--muted);font-size:12px}
  .price{color:var(--price);font-weight:900}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{font-size:11px;padding:2px 8px;border:1px solid #2a315f;border-radius:999px;color:var(--muted)}
  .item-foot{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid #1b1f38;background:#0a0f22}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.show{display:flex}
  .sheet{width:min(920px,94vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .sheet h2{margin:0 0 8px}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input, textarea, select{
    width:100%;background:#0d1226;color:var(--text);border:1px solid var(--line);
    border-radius:12px;padding:10px 12px;outline:none;box-shadow:0 0 0 0 var(--ring)
  }
  input:focus, textarea:focus, select:focus{box-shadow:0 0 0 6px var(--ring);border-color:transparent}
  textarea{min-height:120px;resize:vertical}
  .cols{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:780px){.cols{grid-template-columns:1fr}}
  .drop{border:2px dashed #2a315f;border-radius:14px;padding:14px;text-align:center;cursor:pointer}
  .pgrid{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pthumb{position:relative;width:110px;height:110px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#0b0f24}
  .pthumb img{width:100%;height:100%;object-fit:cover}
  .pthumb button{position:absolute;top:6px;right:6px;background:#0009;color:#fff;border:0;border-radius:8px;padding:4px 6px;cursor:pointer}
  .kbd{font-family:ui-monospace,Consolas,monospace;background:#0b1022;border:1px solid #20284a;border-radius:8px;padding:2px 6px;color:#d1d5db;font-size:12px}
  .hint{color:var(--muted);font-size:12px}
  .footer{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .pill{display:inline-block;padding:3px 8px;border:1px solid #2a315f;border-radius:999px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <h1>Gerenciar Produtos</h1>
    <div class="actions">
      <a class="btn" href="index.html">← Voltar à Loja</a>
      <a class="btn" href="admin-offline.html">+ Adicionar (Admin Offline)</a>
      <button class="btn primary" id="baixarTudo">Baixar produtos.js atualizado</button>
    </div>
  </div>

  <div class="card bar">
    <div class="search" role="search" aria-label="buscar produtos">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input id="q" type="search" placeholder="Buscar por título, categoria, descrição ou tag..." autocomplete="off" />
    </div>
    <span id="count" class="pill">0 itens</span>
  </div>

  <div id="lista" class="grid" aria-live="polite"></div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="hint">Dica: após editar/excluir, clique em <span class="kbd">Baixar produtos.js atualizado</span> para substituir o arquivo na hospedagem.</div>
      <div class="actions"><button class="btn primary" id="baixarTudoBottom">Baixar produtos.js atualizado</button></div>
    </div>
  </div>
</div>

<!-- Carrega os dados -->
<script src="produtos.js"></script>

<!-- Modal de Edição -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Editar produto">
  <div class="sheet">
    <div class="row">
      <h2 id="mTitulo">Editar produto</h2>
      <button id="mClose" class="btn ghost" title="Fechar">✕</button>
    </div>

    <div class="cols">
      <div>
        <label for="fTitulo">Título</label>
        <input id="fTitulo" />

        <label for="fPreco">Preço (R$)</label>
        <input id="fPreco" type="number" step="0.01" min="0" />

        <label for="fPrecoDe">Preço De (opcional)</label>
        <input id="fPrecoDe" type="number" step="0.01" min="0" placeholder="Preço anterior para calcular %OFF" />

        <label for="fCategoria">Categoria</label>
        <input id="fCategoria" placeholder="Ex.: Placa de vídeo (GPU)" />

        <label for="fSelo">Selo (badge opcional)</label>
        <input id="fSelo" placeholder="Ex.: NOVO, OFERTA, -30%" />

        <label for="fTags">Tags (separadas por vírgula)</label>
        <input id="fTags" placeholder="ex.: nvidia, rtx, gamer" />

        <label for="fDesc">Descrição</label>
        <textarea id="fDesc" placeholder="Detalhes, compatibilidade, garantia..."></textarea>

        <div class="hint">Criado em: <span id="fCriado" class="muted">—</span></div>
      </div>

      <div>
        <label>Fotos</label>
        <div id="drop" class="drop">
          <strong>Solte imagens aqui</strong><br>
          <span class="muted">ou clique para selecionar arquivo(s)</span>
        </div>
        <input id="file" type="file" accept="image/*" multiple hidden />
        <div class="hint">As imagens são comprimidas (máx. 1280px, q=0.72). Tamanho recomendado total por produto &lt; 900 KB.</div>
        <div id="pgrid" class="pgrid"></div>
      </div>
    </div>

    <div class="footer">
      <button id="mExcluir" class="btn danger">Excluir produto</button>
      <div style="flex:1"></div>
      <button id="mSalvar" class="btn primary">Salvar alterações</button>
    </div>
  </div>
</div>

<script>
  /* ===== Segurança opcional (mesma senha da loja) ===== */
  (function gate(){
    try{
      if(sessionStorage.getItem('adm_ok')==='1') return;
      const pwd = prompt('Senha do administrador:');
      if(pwd === null){ location.href='index.html'; return; }
      if(pwd === 'PEDRO1503'){ sessionStorage.setItem('adm_ok','1'); return; }
      alert('Senha incorreta.'); location.href='index.html';
    }catch(e){}
  })();

  /* ===== Estado/Dados ===== */
  if(!Array.isArray(window.PRODUTOS)) window.PRODUTOS = [];
  // Garante IDs estáveis (se não tiver, deriva do título + timestamp)
  window.PRODUTOS.forEach((p, i) => { if(!p.id) p.id = (p.titulo||'prod')+'#'+(p.criadoEm||i+'-'+Date.now()); });

  let produtos = window.PRODUTOS;  // referência
  let filtro = '';
  let editId = null;
  const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
  const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  /* ===== DOM ===== */
  const q = document.getElementById('q');
  const lista = document.getElementById('lista');
  const count = document.getElementById('count');
  const m = document.getElementById('modal');
  const mClose = document.getElementById('mClose');
  const mSalvar = document.getElementById('mSalvar');
  const mExcluir = document.getElementById('mExcluir');
  const mTitulo = document.getElementById('mTitulo');

  const fTitulo = document.getElementById('fTitulo');
  const fPreco = document.getElementById('fPreco');
  const fPrecoDe = document.getElementById('fPrecoDe');
  const fCategoria = document.getElementById('fCategoria');
  const fSelo = document.getElementById('fSelo');
  const fTags = document.getElementById('fTags');
  const fDesc = document.getElementById('fDesc');
  const fCriado = document.getElementById('fCriado');
  const drop = document.getElementById('drop');
  const file = document.getElementById('file');
  const pgrid = document.getElementById('pgrid');

  /* ===== Busca ===== */
  q.addEventListener('input', ()=>{ filtro = norm(q.value.trim()); render(); });

  function filtrados(){
    if(!filtro) return produtos.slice();
    return produtos.filter(p=>{
      const hay = norm(`${p.titulo||''} ${p.categoria||''} ${p.descricao||''} ${p.selo||''} ${(p.tags||[]).join(' ')}`);
      return hay.includes(filtro);
    });
  }

  /* ===== Render Lista ===== */
  function render(){
    const arr = filtrados();
    count.textContent = `${arr.length} item${arr.length===1?'':'s'}`;
    lista.innerHTML = '';

    arr.forEach(p=>{
      const img = (Array.isArray(p.fotos) && p.fotos[0]) ? p.fotos[0] : '';
      const preco = fmt.format(Number(p.preco||0));
      const off = p.precoDe ? Math.max(0, Math.round(100 - (p.preco*100/p.precoDe))) : null;
      const card = document.createElement('div');
      card.className = 'item';
      card.innerHTML = `
        <div class="item-head">
          <div class="thumb">${img?`<img src="${img}" alt="">`:''}</div>
          <div class="meta">
            <h3 title="${escapeHTML(p.titulo||'Sem título')}">${escapeHTML(p.titulo||'Sem título')}</h3>
            <div class="muted">${escapeHTML(p.categoria||'Sem categoria')}</div>
            <div style="margin-top:6px">
              <span class="price">${preco}</span>
              ${p.precoDe?`<span class="muted" style="margin-left:6px;text-decoration:line-through">${fmt.format(Number(p.precoDe))}</span>`:''}
              ${off?`<span class="tag" style="margin-left:6px">-${off}%</span>`:''}
              ${p.selo?`<span class="tag" style="margin-left:6px">${escapeHTML(p.selo)}</span>`:''}
            </div>
            ${(p.tags&&p.tags.length)?`<div class="tags">${p.tags.map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>`:''}
          </div>
        </div>
        <div class="item-foot">
          <button class="btn" data-editar="${p.id}">Editar</button>
          <button class="btn danger" data-excluir="${p.id}">Excluir</button>
        </div>
      `;
      lista.appendChild(card);
    });

    // liga os botões
    lista.querySelectorAll('button[data-editar]').forEach(b=> b.onclick = ()=> abrirEditar(b.dataset.editar));
    lista.querySelectorAll('button[data-excluir]').forEach(b=> b.onclick = ()=> excluir(b.dataset.excluir));
  }

  /* ===== Util ===== */
  function escapeHTML(s=''){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function baixarProdutos(){
    const conteudo = `// Arquivo de produtos gerado no admin-gerenciar\nwindow.PRODUTOS = ${JSON.stringify(produtos, null, 2)};`;
    const blob = new Blob([conteudo], {type:'text/javascript;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'produtos.js';
    a.click();
    URL.revokeObjectURL(a.href);
  }
  document.getElementById('baixarTudo').onclick = baixarProdutos;
  document.getElementById('baixarTudoBottom').onclick = baixarProdutos;

  /* ===== Exclusão ===== */
  function excluir(id){
    const p = produtos.find(x=>x.id===id);
    if(!p) return;
    if(!confirm(`Excluir o produto:\n"${p.titulo}" ?`)) return;
    produtos = produtos.filter(x=>x.id!==id);
    window.PRODUTOS = produtos; // mantém sincronizado
    render();
    alert('Produto excluído com sucesso! Lembre-se de baixar o produtos.js atualizado.');
  }

  /* ===== Edição ===== */
  function abrirEditar(id){
    const p = produtos.find(x=>x.id===id);
    if(!p) return;
    editId = id;
    mTitulo.textContent = `Editar: ${p.titulo||'Sem título'}`;
    fTitulo.value = p.titulo||'';
    fPreco.value = (p.preco!=null? Number(p.preco):'');
    fPrecoDe.value = (p.precoDe!=null? Number(p.precoDe):'');
    fCategoria.value = p.categoria||'';
    fSelo.value = p.selo||'';
    fTags.value = Array.isArray(p.tags)? p.tags.join(', ') : '';
    fDesc.value = p.descricao||'';
    fCriado.textContent = p.criadoEm ? new Date(p.criadoEm).toLocaleString() : '—';

    fotosEdicao.splice(0);
    (Array.isArray(p.fotos)? p.fotos:[]).forEach(src=>fotosEdicao.push(src));
    renderFotosEdicao();

    m.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function fecharModal(){
    m.classList.remove('show');
    document.body.style.overflow = '';
    editId = null;
  }
  mClose.onclick = fecharModal;
  m.addEventListener('click', (e)=>{ if(e.target===m) fecharModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && m.classList.contains('show')) fecharModal(); });

  // buffer de fotos do modal
  const fotosEdicao = [];
  function renderFotosEdicao(){
    pgrid.innerHTML = '';
    fotosEdicao.forEach((src,i)=>{
      const d = document.createElement('div');
      d.className = 'pthumb';
      d.innerHTML = `<img src="${src}"><button data-i="${i}" title="Remover">✕</button>`;
      d.querySelector('button').onclick = ev => { fotosEdicao.splice(+ev.target.dataset.i,1); renderFotosEdicao(); };
      pgrid.appendChild(d);
    });
  }

  // upload (drag&drop ou clique)
  drop.addEventListener('click', ()=> file.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor='#6ee7b7'; });
  drop.addEventListener('dragleave', ()=> drop.style.borderColor='#2a315f');
  drop.addEventListener('drop', async e=>{
    e.preventDefault(); drop.style.borderColor='#2a315f';
    await handleFiles(e.dataTransfer.files);
  });
  file.addEventListener('change', async e=>{
    await handleFiles(e.target.files);
    file.value='';
  });

  async function handleFiles(fl){
    for(const f of [...fl]){
      if(!f.type.startsWith('image/')) continue;
      const data = await toDataURLCompressed(f, 1280, 0.72);
      fotosEdicao.push(data);
    }
    renderFotosEdicao();
  }

  function toDataURLCompressed(file, maxW=1280, quality=0.72){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW/img.width);
          const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
          const c = document.createElement('canvas'); c.width=w; c.height=h;
          const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          const mime = file.type==='image/png' ? 'image/png' : 'image/jpeg';
          const q = mime==='image/jpeg' ? quality : undefined;
          resolve(c.toDataURL(mime, q));
        };
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  // salvar alterações
  mSalvar.onclick = ()=>{
    if(!editId) return;
    const idx = produtos.findIndex(x=>x.id===editId);
    if(idx<0) return;

    const preco = Number(fPreco.value||0);
    const precoDe = fPrecoDe.value==='' ? undefined : Number(fPrecoDe.value||0);
    const tags = fTags.value.trim() ? fTags.value.split(',').map(s=>s.trim()).filter(Boolean) : [];

    const novo = {
      ...produtos[idx],
      titulo: fTitulo.value.trim() || 'Sem título',
      preco: isNaN(preco)?0:preco,
      precoDe: (precoDe===undefined? undefined : (isNaN(precoDe)? undefined : precoDe)),
      categoria: fCategoria.value.trim() || null,
      selo: fSelo.value.trim() || undefined,
      tags,
      descricao: fDesc.value.trim() || null,
      fotos: fotosEdicao.slice(),
      atualizadoEm: new Date().toISOString()
    };
    produtos[idx] = novo;
    window.PRODUTOS = produtos;
    fecharModal();
    render();
    alert('Alterações salvas! Não esqueça de baixar o produtos.js atualizado.');
  };

  // exclusão via modal
  mExcluir.onclick = ()=>{
    if(!editId) return;
    const p = produtos.find(x=>x.id===editId);
    if(!p) return;
    if(!confirm(`Tem certeza que deseja excluir:\n"${p.titulo}" ?`)) return;
    produtos = produtos.filter(x=>x.id!==editId);
    window.PRODUTOS = produtos;
    fecharModal();
    render();
    alert('Produto excluído com sucesso! Baixe o produtos.js atualizado para publicar.');
  };

  /* ===== Start ===== */
  render();
</script>
</body>
</html>
